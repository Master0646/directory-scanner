name: ğŸ“¦ è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾ (ä¾‹å¦‚: v1.0.0)'
        required: true
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'
  APP_NAME: 'ç›®å½•æ–‡ä»¶ç”Ÿæˆå™¨'

jobs:
  # æ„å»ºæ‰€æœ‰å¹³å°
  build-all:
    name: ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            script: build_windows_fixed.py
            artifact-name: Windows-x64
            artifact-path: 'dist/*.exe'
            release-name: 'Windows-x64.exe'
          - os: macos-latest
            platform: macos
            script: build_macos_fixed.py
            artifact-name: macOS-Universal
            artifact-path: 'dist/*.app'
            release-name: 'macOS-Universal.app'
          - os: ubuntu-latest
            platform: linux
            script: cross_platform_build.py
            artifact-name: Linux-x64
            artifact-path: 'dist/*'
            release-name: 'Linux-x64'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: è¿è¡Œé¢„æ„å»ºæ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œé¢„æ„å»ºæ£€æŸ¥..."
        python test_build_scripts.py
        python runtime_error_detector.py
    
    - name: æ‰§è¡Œæ„å»º
      run: |
        echo "ğŸ”¨ å¼€å§‹ ${{ matrix.platform }} å¹³å°æ„å»º..."
        python ${{ matrix.script }}
    
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        mkdir -p release
        
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windows: å¤åˆ¶exeæ–‡ä»¶
          find dist/ -name "*.exe" -exec cp {} release/${{ env.APP_NAME }}-${{ matrix.release-name }} \;
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          # macOS: æ‰“åŒ…appä¸ºzip
          cd dist
          zip -r ../release/${{ env.APP_NAME }}-${{ matrix.release-name }}.zip *.app
          cd ..
        else
          # Linux: æ‰“åŒ…ä¸ºtar.gz
          cd dist
          tar -czf ../release/${{ env.APP_NAME }}-${{ matrix.release-name }}.tar.gz *
          cd ..
        fi
        
        echo "ğŸ“‹ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
        ls -la release/
    
    - name: ä¸Šä¼ å‘å¸ƒæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.platform }}
        path: release/
        retention-days: 30

  # åˆ›å»ºGitHub Release
  create-release:
    name: ğŸš€ åˆ›å»ºå‘å¸ƒ
    needs: build-all
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event.inputs.tag }}" != "" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG=${GITHUB_REF#refs/tags/}
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=${TAG#v}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: $TAG"
    
    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        echo "ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
        
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ "$PREV_TAG" != "" ]; then
          echo "ğŸ“‹ è‡ª $PREV_TAG ä»¥æ¥çš„æ›´æ”¹:"
          CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD)
        else
          echo "ğŸ“‹ é¦–æ¬¡å‘å¸ƒ"
          CHANGELOG="é¦–æ¬¡å‘å¸ƒ ${{ env.APP_NAME }}"
        fi
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        cat > release_notes.md << EOF
        # ${{ env.APP_NAME }} ${{ steps.version.outputs.version }}
        
        ## ğŸ“¦ ä¸‹è½½
        
        | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
        |------|------|------|
        | Windows | \`${{ env.APP_NAME }}-Windows-x64.exe\` | Windows å¯æ‰§è¡Œæ–‡ä»¶ |
        | macOS | \`${{ env.APP_NAME }}-macOS-Universal.app.zip\` | macOS åº”ç”¨ç¨‹åºåŒ… |
        | Linux | \`${{ env.APP_NAME }}-Linux-x64.tar.gz\` | Linux å¯æ‰§è¡Œæ–‡ä»¶ |
        
        ## ğŸ”§ å®‰è£…è¯´æ˜
        
        ### Windows
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-Windows-x64.exe\`
        2. åŒå‡»è¿è¡Œå³å¯
        
        ### macOS
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-macOS-Universal.app.zip\`
        2. è§£å‹ç¼©åå°†åº”ç”¨æ‹–å…¥åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
        3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
        
        ### Linux
        1. ä¸‹è½½ \`${{ env.APP_NAME }}-Linux-x64.tar.gz\`
        2. è§£å‹ç¼©: \`tar -xzf ${{ env.APP_NAME }}-Linux-x64.tar.gz\`
        3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
        
        ## ğŸ“‹ æ›´æ–°å†…å®¹
        
        $CHANGELOG
        
        ## âš ï¸ ç³»ç»Ÿè¦æ±‚
        
        - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **macOS**: macOS 10.14 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **Linux**: æ”¯æŒ GTK çš„ç°ä»£ Linux å‘è¡Œç‰ˆ
        
        ## ğŸ› é—®é¢˜åé¦ˆ
        
        å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
        EOF
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        pattern: release-*
        path: all-releases
        merge-multiple: true
    
    - name: éªŒè¯å‘å¸ƒæ–‡ä»¶
      run: |
        echo "ğŸ“‹ æ‰€æœ‰å‘å¸ƒæ–‡ä»¶:"
        find all-releases -type f -exec echo "  {}" \;
        
        echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
        find all-releases -type f -exec ls -lh {} \;
    
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: ${{ env.APP_NAME }} ${{ steps.version.outputs.version }}
        body: ${{ steps.changelog.outputs.changelog }}
        files: all-releases/*
        prerelease: ${{ github.event.inputs.prerelease || false }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.tag }}"
        echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        echo "ğŸ“ åŒ…å«æ–‡ä»¶:"
        find all-releases -type f -exec basename {} \;